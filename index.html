<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<title>Загрузка</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  :root {
    /* Telegram theme */
    --bg: var(--tg-theme-bg-color, #ffffff);
    --text: var(--tg-theme-text-color, #000000);
    --hint: var(--tg-theme-hint-color, #888888);
    --button: var(--tg-theme-button-color, #000000);
    --button-text: var(--tg-theme-button-text-color, #ffffff);
    --card: var(--tg-theme-secondary-bg-color, #f6f6f6);
    --radius: 14px;
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom);
    font-family: system-ui, -apple-system, BlinkMacSystemFont;
    background: var(--bg);
    color: var(--text);
  }

  h1 {
    font-size: 20px;
    margin-bottom: 16px;
  }

  p {
    margin: 6px 0 10px;
    font-size: 13px;
    color: var(--hint);
    line-height: 1.4;
  }

  .card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 14px;
  }

  label {
    font-size: 13px;
    color: var(--hint);
    margin-bottom: 6px;
    display: block;
  }

  input,
  select,
  textarea {
    width: 100%;
    padding: 14px;
    border-radius: var(--radius);
    border: none;
    font-size: 16px;
    background: var(--bg);
    color: var(--text);
  }

  textarea {
    resize: none;
  }

  input[type="file"] {
    padding: 12px;
  }

  ::placeholder {
    color: var(--hint);
  }

  button {
    width: 100%;
    padding: 16px;
    border-radius: var(--radius);
    border: none;
    background: var(--button);
    color: var(--button-text);
    font-size: 16px;
    font-weight: 600;
    margin-top: 10px;
  }

  .preview {
    width: 100%;
    height: 180px;
    background: rgba(0,0,0,0.05);
    border-radius: var(--radius);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    font-size: 14px;
    color: var(--hint);
  }

  .preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* ===== ЛОАДЕР ===== */

  #loader {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.35);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .spinner {
    width: 48px;
    height: 48px;
    border: 4px solid rgba(255,255,255,0.3);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .error {
    outline: 2px solid #ff4d4f;
  }
</style>
</head>

<body>

  <!-- Лоадер -->
<div id="loader">
  <div class="spinner"></div>
</div>

<h1>Загрузка данных</h1>

<div class="card">
  <label>Фото</label>
  <div class="preview" id="preview">Нет фото</div>
  <input type="file" id="photo" accept="image/*">
</div>

<div class="card">
  <label>УТП продукта</label>
  <p>УТП продукта — это уникальное торговое предложение.
Простой смысл: ответ на вопрос «почему клиент должен выбрать именно этот продукт, а не любой другой».</p>
  <input type="text" id="text1" placeholder="Опишите УТП продукта">
</div>

<div class="card">
  <label>Формат</label>
  <p>Формат отвечает за визуальное кадрирование.</p>
  <p>В формате "руки в кадре", акцент на продукте и руках. Озвучка закадровая.</p>
  <p>В формате "персонаж с продуктом в кадре", акцент на продукте и персонаже. Персонаж говорит в кадре.</p>
  <select id="select1">
    <option value="">Выберите</option>
    <option>руки в кадре</option>
    <option>говорящая голова</option>
    <!-- <option>демонстрация продукта</option> -->
    <option>персонаж с продуктом в кадре</option>
  </select>
</div>

<div class="card">
  <label>Жанр</label>
  <p>Жанр отвечает через какую тему будет раскрыто УТП продукта.</p>
  <select id="select2">
    <option value="">Выберите</option>
    <option>FAQ-контент (ответы на вопросы)</option>
    <option>обзор на продукт</option>
    <option>личный опыт покупателя</option>
    <option>до/после</option>
    <option>ритуал ухода</option>
  </select>
</div>

<div class="card">
  <label>Дополнительная информация</label>
  <p>Любая дополнительная информация о продутке для того, чтобы раскрыть тему жанра. Можно указать предпочтения по локации</p>
  <textarea id="text2" rows="3" placeholder="Дополнительная информация"></textarea>
</div>

<div class="card">
  <label>Тон</label>
  <p>Тон отвечает за подачу материала.</p>
  <select id="select3">
    <option value="">Выберите</option>
    <option>ugc контент</option>
    <option>экспертный</option>
    <option>лайфстайл</option>
    <option>развлекательный</option>
    <option>продающий</option>
    <option>обучающий</option>
  </select>
</div>

<div class="card">
  <label>Цель</label>
  <p>Цель отвечает за главную маркетинговую задачу рекламного ролика.</p>
  <select id="select4">
    <option value="">Выберите</option>
    <option>продажи</option>
    <option>узнаваемость</option>
    <option>доверие</option>
    <option>комьюнити</option>
    <option>анонс новинки</option>
    <option>привлечь внимание</option>
  </select>
</div>

<button onclick="send()">Отправить</button>

<script>
  const tg = window.Telegram.WebApp;
  tg.expand();

  const photoInput = document.getElementById("photo");
  const preview = document.getElementById("preview");

  const loader = document.getElementById('loader');
  const showLoader = () => loader.style.display = 'flex';
  const hideLoader = () => loader.style.display = 'none';

  photoInput.addEventListener("change", () => {
    const file = photoInput.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      preview.innerHTML = `<img src="${reader.result}" />`;
    };
    reader.readAsDataURL(file);
  });

  function send() {
    if (!validateForm()) return;

    showLoader();
    const file = photoInput.files[0];
    if (!file) {
      return alert("Добавьте фото");
      hideLoader();
    };

    const reader = new FileReader();
    reader.onload = async () => {
      const base64 = reader.result.split(",")[1];

      await fetch("https://garaga-n8n.ru/webhook/telegram-upload", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          photo: base64,
          photo_name: file.name,
          photo_type: file.type,
          text1: text1.value,
          text2: text2.value,
          select1: select1.value,
          select2: select2.value,
          select3: select3.value,
          select4: select4.value,
          telegram_user: tg.initDataUnsafe?.user || null
        })
      })
      .then(() => {
        alert('Задача сохранёна ✅');
        tg.close();
      })
      .catch(err => {
        console.error('SAVE ERROR:', err);
        alert('Ошибка сохранения. Попробуйте ещё раз.');
      })
      .finally(() => {
        hideLoader();
      });

    };
    reader.readAsDataURL(file);
  }


  function validateForm() {
    let valid = true;

    const requiredFields = [
      photoInput,
      text1,
      select1,
      select2,
      select3,
      select4
    ];

    requiredFields.forEach(field => {
      field.classList.remove('error');

      if (
        (field.type === 'file' && !field.files.length) ||
        (field.tagName === 'SELECT' && !field.value) ||
        (field.tagName !== 'SELECT' && field.type !== 'file' && !field.value.trim())
      ) {
        field.classList.add('error');
        valid = false;
      }
    });

    if (!valid) {
      alert('Пожалуйста, заполните все обязательные поля');
    }

    return valid;
  }
</script>

</body>
</html>
